define(["jquery","home/port"],function(a,b){function c(){a(".collection-modal input").each(function(){this.checked&&(h=a(this).attr("shop_id"),i["shop_id_"+h]=new Array(2),i["shop_id_"+h].shop_id=h,i["shop_id_"+h].place_id=a(this).attr("place_id"))})}function d(){a(".collection-row-none").on("click",function(){var b=a(this).data("is_login"),c=a(this).data("next_src");b?(a(".collection-modal").css("display","block"),a(".modal-backdrop").css("display","block")):(alert("亲! 还没登录呢! "),location.href=c)}),a(".collection-row-book .collection-row-book-close").on("click",function(){var c=a(this).parents(".collection-row-book"),g=c.data("shop_id"),h=c.data("place_id"),i={};i.shop_id=g,i.place_id=h,a.ajax({url:b.addCollection,type:"POST",data:i,success:function(a){"true"==a.success?(e(a.data),f(g),d()):alert("取消收藏失败，请重试")}}),i={}})}function e(b){var c=_.template(a("#collection-row").html())(b);a(".collection .collection-row").html(c)}function f(b){var c=".restaurant-"+b,d=a(c);d.find(".collect_star").css("display","none"),d.find(".uncollect").removeClass("change"),d.find(".collect").addClass("change")}function g(b){var c=".restaurant-"+b,d=a(c);d.find(".collect_star").css("display","block"),d.find(".collect").removeClass("change"),d.find(".uncollect").addClass("change")}console.log("my collection alert loaded");var h,i=[],j=[],k={};window.onload=function(){c()},d(),a(".collection-modal").on("click",function(l){var m=l.target.className||null;switch(m){case"check":var n=a(l.target).attr("shop_id"),o=l.target.checked,p=a(".collection-modal").find("input[shop_id='"+n+"']");p.each(function(){this.checked=o});break;case"set close":a(".collection-modal").css("display","none"),a(".modal-backdrop").css("display","none");break;case"btn btn-yellow":a(".collection-modal").css("display","none"),a(".modal-backdrop").css("display","none"),a(".collection-modal input").each(function(){this.checked&&(h=a(this).attr("shop_id"),j["shop_id_"+h]=new Array(2),j["shop_id_"+h].shop_id=h,j["shop_id_"+h].place_id=a(this).attr("place_id"))}),Object.keys(j).forEach(function(a){i[a]&&(delete i[a],delete j[a])}),k={},k.add_collection=[],k.cancel_collection=[],Object.keys(j).forEach(function(a,b){k.add_collection[b]={},k.add_collection[b]={shop_id:j[a].shop_id,place_id:j[a].place_id}}),Object.keys(i).forEach(function(a,b){k.cancel_collection[b]={},k.cancel_collection[b]={shop_id:i[a].shop_id,place_id:i[a].place_id}}),(k.add_collection.length||k.cancel_collection.length)&&a.ajax({url:b.collectList,type:"POST",data:k,success:function(a){if("true"==a.success){if(e(a.data),k.add_collection.length)for(var b=k.add_collection.length-1;b>=0;b--)g(k.add_collection[b].shop_id);if(k.cancel_collection.length)for(var b=k.cancel_collection.length-1;b>=0;b--)f(k.cancel_collection[b].shop_id);d()}else alert("收藏失败，请重新收藏")}}),i=[],c(),j=[];break;case"p_hot":a(".collection-modal .new-res").css("display","none"),a(".collection-modal .p_new").removeClass("action"),a(".collection-modal .hot-res").css("display","block"),a(".collection-modal .p_hot").addClass("action");break;case"p_new":a(".collection-modal .hot-res").css("display","none"),a(".collection-modal .p_hot").removeClass("action"),a(".collection-modal .new-res").css("display","block"),a(".collection-modal .p_new").addClass("action")}}),a(".more_shops-row-book .uncollect").on("click",function(){var c=a(this).parents(".more_shops-row-book"),g=c.data("shop_id"),h=c.data("place_id"),i={};i.shop_id=g,i.place_id=h,a.ajax({url:b.cancelCollection,type:"POST",data:i,success:function(a){"true"==a.success?(e(a.data),f(g),d()):alert("取消收藏失败，请重试")}}),i={}}),a(".more_shops-row-book .collect").on("click",function(){var b=a(this).parents(".more_shops-row-book"),c=b.data("shop_id"),f=b.data("place_id"),h={};h.shop_id=c,h.place_id=f,a.ajax({url:"collectshop",type:"POST",data:h,success:function(a){"true"==a.success?(e(a.data),g(c),d()):alert("收藏失败，请重新收藏")}}),h={}})});