define(["jquery","underscore"],function(a,b){console.log("map loaded");var c=function(){var c=new AMap.Map("container",{view:new AMap.View2D({zoom:12}),keyboardEnable:!1}),d=document,e="重庆",f={};return c.getCityInfo=function(){c.plugin(["AMap.CitySearch"],function(){var a=new AMap.CitySearch;a.getLocalCity(),AMap.event.addListener(a,"complete",function(a){a&&a.city&&a.bounds?(e=a.city,f=a.bounds):e=a.info}),AMap.event.addListener(a,"error",function(a){alert(a.info)})})}(),c.getCoder=function(a,b,d){var e=new AMap.LngLat(a,b);c.plugin(["AMap.Geocoder"],function(){MGeocoder=new AMap.Geocoder({radius:1e3,extensions:"all"}),AMap.event.addListener(MGeocoder,"complete",d),MGeocoder.getAddress(e)})},c.pointWindow=function(d,e){var f=this;f.getCoder(d,e,function(f){console.log(f);var g=b.template(a("#point_template").html())({data:f.regeocode.addressComponent}),h=new AMap.InfoWindow({content:g,size:new AMap.Size(300,0),autoMove:!0,offset:new AMap.Pixel(0,-30)});h.open(c,new AMap.LngLat(d,e))})},function(e){var f=e.autoComplete,g=e.drag;return f?(f.windowsArr=[],f.marker=[],f.keydown=function(){var a=this,b=a.input,c=a.result,e=(event||window.event).keyCode,c=d.getElementById(c),f=c.curSelect;if(40===e)f+1<c.children.length&&(c.children[f]&&(c.children[f].style.background=""),c.curSelect=f+1,c.children[f+1].style.background="#CAE1FF",d.getElementById(b).value=c.tipArr[f+1].name);else if(38===e)f-1>=0&&(c.children[f]&&(c.children[f].style.background=""),c.curSelect=f-1,c.children[f-1].style.background="#CAE1FF",d.getElementById(b).value=c.tipArr[f-1].name);else if(13===e){var g=d.getElementById(b);g&&-1!==g.curSelect&&a.selectResult(c.curSelect)}else a.autoSearch()},f.autoSearch=function(){var a,b=this,e=b.input,f=b.result,g=d.getElementById(e).value;c.plugin(["AMap.Autocomplete"],function(){var c={city:""};a=new AMap.Autocomplete(c),g.length>0?(AMap.event.addListener(a,"complete",function(a){b.autocomplete_CallBack.call(b,a)}),a.search(g)):d.getElementById(f).style.display="none"})},f.autocomplete_CallBack=function(c){var d=this,e=(a("#"+d.input),a("#"+d.result)),f="",g=c.tips;g&&g.length>0&&(f=b.template(a("#list_template").html())({tipArr:g})),e[0].curSelect=-1,e[0].tipArr=g,e.html(f),e[0].style.display="block",e.on("mouseover",function(a){var b=a.target;if("divid"==b.className){var c=b.dataset.mouoseover;d.openMarkerTipById(c,b)}}),e.on("mouseout","div",function(a){var b=a.target;if("divid"==b.className){var c=b.dataset.mouseout;d.onmouseout_MarkerStyle(c,b)}}),e.on("click","div",function(a){var b=a.target;if("divid"==b.className){var c=parseInt(b.dataset.select);d.selectResult(c)}})},f.openMarkerTipById=function(a,b){b.style.background="#CAE1FF"},f.onmouseout_MarkerStyle=function(a,b){b.style.background=""},f.selectResult=function(a){var b=this,e=b.input,f=b.result;if(!(0>a)){navigator.userAgent.indexOf("MSIE")>0&&(d.getElementById(e).onpropertychange=null,d.getElementById(e).onfocus=b.focus_callback);var g=d.getElementById("divid"+(a+1)).innerHTML.replace(/\s|<[^>].*?>.*<\/[^>].*?>/g,""),h=d.getElementById("divid"+(a+1)).getAttribute("data");d.getElementById(e).value=g,d.getElementById(f).style.display="none",c.plugin(["AMap.PlaceSearch"],function(){var a=new AMap.PlaceSearch;AMap.event.addListener(a,"complete",b.placeSearch_CallBack),a.setCity(h),a.search(g)})}},f.focus_callback=function(){var a=this,b=a.input;a.result,navigator.userAgent.indexOf("MSIE")>0&&(document.getElementById(b).onpropertychange=a.autoSearch)},f.placeSearch_CallBack=function(d){var e=f,h=(a("#"+e.input),a("#"+e.city));f.windowsArr=[],f.marker=[],c.clearMap();var i,j=d.poiList.pois,k=j.length;i=b.template(a("#place_template").html())({resultCount:k,autoComplete:f,poiArr:j}),c.setFitView(),h.html(i),h.show(),g&&(a(".drag-wrap").css({left:450}),g.funcs.updateDragPosition()),h.on("mouseover","li",function(a){var b=a.currentTarget;if("secid"==b.className){var c=parseInt(b.dataset.mouseover);e.openMarkerTipById(c,b)}}),h.on("mouseout","li",function(a){var b=a.currentTarget;if("secid"==b.className){var c=b.dataset.mouseout;e.onmouseout_MarkerStyle(c,b)}}),h.on("click","li",function(a){var b=a.currentTarget;if("secid"==b.className){var c=parseInt(b.dataset.mouseover);e.openMarkerTipById1(c,b,k)}})},f.openMarkerTipById1=function(b,d,e){d.style.background="#CAE1FF",f.windowsArr[b].open(c,f.marker[b]);for(var g=0;e>g;g++)a(".icon"+(g+1)).each(function(a,b){b.className="icon icon"+(g+1)+"_b"});a(".icon"+(parseInt(b)+1)+"_b").each(function(a,c){c.className="icon icon"+(parseInt(b)+1)})},f.onmouseout_iconStyle=function(b,c){c.style.background="",a(".icon"+parseInt(b)).each(function(a,c){c.className="icon icon"+b+"_b"})},f.addmarker=function(d,e){var g=this,h=(g.input,g.result,e.location.getLng()),i=e.location.getLat(),j={map:c,content:"<div class='icon icon"+(d+1)+"_b'></div>",position:new AMap.LngLat(h,i)},k=new AMap.Marker(j);f.marker.push(new AMap.LngLat(h,i));var l=b.template(a("#windowInfo_template").html())({i:d,d:e}),m=new AMap.InfoWindow({content:l,size:new AMap.Size(300,0),autoMove:!0,offset:new AMap.Pixel(0,-30)});f.windowsArr.push(m);var n=function(){m.open(c,k.getPosition())};AMap.event.addListener(k,"click",n)},f.TipContents=function(a,b,c){var d=this;d.input,d.result,(""==a||"undefined"==a||null==a||" undefined"==a||"undefined"==typeof a)&&(a="暂无"),(""==b||"undefined"==b||null==b||" undefined"==b||"undefined"==typeof b)&&(b="暂无"),(""==c||"undefined"==c||null==c||" undefined"==c||"tel"==typeof b)&&(c="暂无");var e="  地址："+b+"<br />  电话："+c+" <br />  类型："+a;return e}):a(".search").css("display","none"),c.init=function(){e.autoComplete&&a("#"+e.autoComplete.input).on("keyup",function(){f.keydown.call(e.autoComplete)})},g?g.funcs=function(){function b(){var b=parseInt(a(this).css("height")),c=parseInt(a(this).css("width"))/2;g.addClass("drag-ing");var f,i=h.offset();h.on("mousemove",d(b,c,i,f)),h.on("mouseup",e(b,c,i,f))}function d(a,b,c){return function(d){var e=d.clientX,f=d.clientY,h=(g.offset(),e-c.left-i.left-b),j=f-c.top-i.top-a;g.css({top:j,left:h})}}function e(b,d,e){return function(){g.removeClass("drag-ing");var d=f(g.offset().left-e.left,g.offset().top-e.top+b);g.attr("data-lat",d.lat),g.attr("data-lng",d.lng);var i=new AMap.Marker({icon:new AMap.Icon({size:new AMap.Size(28,34),image:"image/map-sprites.png",imageOffset:new AMap.Pixel(0,-140)}),position:new AMap.LngLat(d.lng,d.lat),draggable:!0,cursor:"move",raiseOnDrag:!0});i.setMap(c),new AMap.InfoWindow({isCustom:!0,content:c.pointWindow(d.lng,d.lat),offset:new AMap.Pixel(110,-25)}),AMap.event.addListener(i,"mouseup",function(){var d=(window.event,a(i.$.r.B).offset()),g=f(d.left-e.left+7,d.top-e.top+2*b);new AMap.InfoWindow({isCustom:!0,content:c.pointWindow(g.lng,g.lat),offset:new AMap.Pixel(110,-25)})}),h.off("mousemove"),h.off("mouseup"),g.css({top:0,left:0})}}function f(a,b){var d=c.containTolnglat(new AMap.Pixel(a,b));return{lng:d.getLng(),lat:d.getLat()}}var g=a(".drag-pin"),h=a(".container"),i=g.offset();return g.on("mousedown",b),{updateDragPosition:function(){i=g.offset(),i.left-=h.offset().left}}}():a(".drap-main").css("display","none"),c}}();c({autoComplete:{input:"keyword",result:"result1",city:"city"},toolBar:{},drag:{}}).init()});