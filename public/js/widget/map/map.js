define(["jquery","underscore","search/port","JSON"],function(a,b,c){console.log("map loaded");var d=function(){var d=new AMap.Map("container",{view:new AMap.View2D({zoom:12}),keyboardEnable:!1}),e=document,f="重庆",g={};return d.getCityInfo=function(){d.plugin(["AMap.CitySearch"],function(){var a=new AMap.CitySearch;a.getLocalCity(),AMap.event.addListener(a,"complete",function(a){a&&a.city&&a.bounds?(f=a.city,g=a.bounds):f=a.info}),AMap.event.addListener(a,"error",function(a){alert(a.info)})})}(),d.getCoder=function(a,b,c){var e=new AMap.LngLat(a,b);d.plugin(["AMap.Geocoder"],function(){MGeocoder=new AMap.Geocoder({radius:1e3,extensions:"all"}),AMap.event.addListener(MGeocoder,"complete",c),MGeocoder.getAddress(e)})},d.pointWindow=function(c,e,f){var g=this;g.getCoder(c,e,function(g){var h=b.template(a("#point_template").html())({data:g.regeocode.addressComponent,count:f}),i=new AMap.InfoWindow({content:h,size:new AMap.Size(300,0),autoMove:!0,offset:new AMap.Pixel(0,-30)});i.open(d,new AMap.LngLat(c,e))})},function(f){var g=f.autoComplete,h=f.scale,i=f.toolbar,j=f.drag;return h&&(console.log("scale"),d.plugin(["AMap.Scale"],function(){var a=new AMap.Scale;d.addControl(a)})),i&&(console.log("toolbar"),d.plugin(["AMap.ToolBar"],function(){var a=new AMap.ToolBar({offset:new AMap.Pixel(5,300)});d.addControl(a)})),g?(g.windowsArr=[],g.marker=[],g.keydown=function(){var a=this,b=a.input,c=a.result,d=(event||window.event).keyCode,c=e.getElementById(c),f=c.curSelect;if(40===d)f+1<c.children.length&&(c.children[f]&&(c.children[f].style.background=""),c.curSelect=f+1,c.children[f+1].style.background="#CAE1FF",e.getElementById(b).value=c.tipArr[f+1].name);else if(38===d)f-1>=0&&(c.children[f]&&(c.children[f].style.background=""),c.curSelect=f-1,c.children[f-1].style.background="#CAE1FF",e.getElementById(b).value=c.tipArr[f-1].name);else if(13===d){var g=e.getElementById(b);g&&-1!==g.curSelect&&a.selectResult(c.curSelect)}else a.autoSearch()},g.autoSearch=function(){var a,b=this,c=b.input,f=b.result,g=e.getElementById(c).value;d.plugin(["AMap.Autocomplete"],function(){var c={city:""};a=new AMap.Autocomplete(c),g.length>0?(AMap.event.addListener(a,"complete",function(a){console.log(a),b.autocomplete_CallBack.call(b,a)}),a.search(g)):e.getElementById(f).style.display="none"})},g.autocomplete_CallBack=function(c){var d=this,e=(a("#"+d.input),a("#"+d.result)),f="",g=c.tips;g&&g.length>0&&(f=b.template(a("#list_template").html())({tipArr:g})),e[0].curSelect=-1,e[0].tipArr=g,e.html(f),e[0].style.display="block",e.on("mouseover",function(a){var b=a.target;if("divid"==b.className){var c=b.dataset.mouoseover;d.openMarkerTipById(c,b)}}),e.on("mouseout","div",function(a){var b=a.target;if("divid"==b.className){var c=b.dataset.mouseout;d.onmouseout_MarkerStyle(c,b)}}),e.on("click","div",function(a){var b=a.target;if("divid"==b.className){var c=parseInt(b.dataset.select);d.selectResult(c)}})},g.openMarkerTipById=function(a,b){b.style.background="#CAE1FF"},g.onmouseout_MarkerStyle=function(a,b){b.style.background=""},g.selectResult=function(a){console.log(a);var b=this,c=b.input,f=b.result;if(!(0>a)){navigator.userAgent.indexOf("MSIE")>0&&(e.getElementById(c).onpropertychange=null,e.getElementById(c).onfocus=b.focus_callback);var g=e.getElementById("divid"+(a+1)).innerHTML.replace(/\s|<[^>].*?>.*<\/[^>].*?>/g,"");e.getElementById("divid"+(a+1)).getAttribute("data"),e.getElementById(c).value=g,e.getElementById(f).style.display="none",d.plugin(["AMap.PlaceSearch"],function(){var a=new AMap.PlaceSearch({pageSize:20});AMap.event.addListener(a,"complete",b.placeSearch_CallBack),a.search(g)})}},g.focus_callback=function(){var a=this,b=a.input;a.result,navigator.userAgent.indexOf("MSIE")>0&&(document.getElementById(b).onpropertychange=a.autoSearch)},g.render=function(){var c=this,e=a("#"+c.city),f=c.poil,g=c.restaurantCount;f.length<10&&(c.resultEnd=f.length);var h=f.slice(c.resultIndex,c.resultEnd),i=Math.ceil(f.length/10),j=b.template(a("#place_template").html())({resultCount:i,resultIndex:c.resultIndex,autoComplete:c,poiArr:h,poil:f,restaurantCount:g});d.setFitView(),e.html(j),e.show(),e.on("click","li",function(a){var b=a.currentTarget;if("secid"==b.className){console.log(2);var d=parseInt(b.dataset.mouseover);return console.log(d),c.openMarkerTipById1(d,b,i),!1}})},g.bindNext=function(b){var c=g,d=a("#"+c.city),e=b.currentTarget;"nextGroup"!=!e.className&&(c.resultIndex+=10,c.resultEnd+=10,c.resultEnd>c.poil.length&&(c.resultEnd=c.poil.length),c.changePage(c.resultIndex,c.resultEnd),c.render(),d.animate({scrollTop:0}))},g.bindPrev=function(b){var c=g,d=a("#"+c.city),e=b.currentTarget;"prevGroup"!=!e.className&&(c.resultIndex-=10,c.resultEnd-=10,c.changePage(c.resultIndex,c.resultEnd),c.render(),d.animate({scrollTop:0}))},g.placeSearch_CallBack=function(b){for(var e=g,f=(a("#"+e.input),a("#"+e.city)),h=[],i=[],k=b.poiList.pois,l=0,m=k.length;m>l;l++)h.push([k[l].location.lng,k[l].location.lat]);a.ajax({url:c.getRestaurant,type:"POST",data:JSON.encode({restaurant:h}),contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(b){g.restaurantCount=b,g.windowsArr=[],g.marker=[],g.data=b,g.resultIndex=0,g.resultEnd=10,g.poil=k,g.restaurantResult=i,d.clearMap(),e.render(),j&&(a(".drag-wrap").css({left:450}),j.funcs.updateDragPosition()),f.on("mouseover","li",function(a){var b=a.currentTarget;if("secid"==b.className){var c=parseInt(b.dataset.mouseover);e.openMarkerTipById(c,b)}}),a(".prevGroup").on("click",e.bindPrev),f.on("mouseout","li",function(a){var b=a.currentTarget;if("secid"==b.className){var c=b.dataset.mouseout;e.onmouseout_MarkerStyle(c,b)}})}})},g.openMarkerTipById1=function(b,c,e){c&&(c.style.background="#CAE1FF"),console.log(b,c,e),g.windowsArr[b].open(d,g.marker[b]);for(var f=0;e>=f;f++)a(".icon"+(f+1)).each(function(a,b){b.className="icon icon"+(f+1)+"_b"});a(".icon"+(parseInt(b)+1)+"_b").each(function(a,c){c.className="icon icon"+(parseInt(b)+1)})},g.changePage=function(b,c){g.windowsArr[b].open(d,g.marker[b]);for(var e=0;c-b>e;e++)a(".icon"+(e+1)).each(function(a,b){b.className="icon icon"+(e+1)+"_b"});a(".icon"+(parseInt(b)+1)+"_b").each(function(a,c){c.className="icon icon"+(parseInt(b)+1)})},g.onmouseout_iconStyle=function(b,c){c.style.background="",a(".icon"+parseInt(b)).each(function(a,c){c.className="icon icon"+b+"_b"})},g.addmarker=function(c,e){var f=this,h=(f.input,f.result,f.restaurantCount),i=e.location.lng,j=e.location.lat,k={map:d,content:"<div class='icon icon"+(c+1)+"_b'></div>",position:new AMap.LngLat(i,j)},l=new AMap.Marker(k);g.marker.push(new AMap.LngLat(i,j));var m=b.template(a("#windowInfo_template").html())({i:c,d:e,jump_url:e.jump_url,restaurantCount:h}),n=new AMap.InfoWindow({content:m,size:new AMap.Size(300,0),autoMove:!0,offset:new AMap.Pixel(0,-30)});g.windowsArr.push(n);var o=function(){n.open(d,l.getPosition())};AMap.event.addListener(l,"click",o)}):a(".search").css("display","none"),d.init=function(){f.autoComplete&&a("#"+f.autoComplete.input).on("keyup",function(){g.keydown.call(f.autoComplete)})},j?j.funcs=function(){function b(){var b=parseInt(a(this).css("height")),c=parseInt(a(this).css("width"))/2;h.addClass("drag-ing");var d,g=i.offset();i.on("mousemove",e(b,c,g,d)),i.on("mouseup",f(b,c,g,d))}function e(a,b){return function(c){var d=c.clientX,e=c.clientY,f=(h.offset(),d-j.left-b),g=e-j.top-a;h.css({top:g,left:f})}}function f(b,e,f){return function(){h.removeClass("drag-ing");var e=g(h.offset().left-f.left,h.offset().top-f.top+b);h.attr("data-lat",e.lat),h.attr("data-lng",e.lng);var j=[[e.lng,e.lat]];a.ajax({url:c.getRestaurant,type:"POST",data:JSON.encode({restaurant:j}),contentType:"application/json; charset=utf-8",dataType:"json",async:!1,success:function(b){var c=new AMap.Marker({icon:new AMap.Icon({size:new AMap.Size(28,34),image:"./images/map-sprites.png",imageOffset:new AMap.Pixel(0,-140)}),position:new AMap.LngLat(e.lng,e.lat),draggable:!0,cursor:"move",raiseOnDrag:!0});c.setMap(d),new AMap.InfoWindow({isCustom:!0,content:d.pointWindow(e.lng,e.lat,b[0]),offset:new AMap.Pixel(110,-25)}),AMap.event.addListener(c,"mouseup",function(c){var e=a(c.target.da.bd.contentDom),h=e.offset(),i=g(h.left-f.left+7,h.top-f.top+2*e.height());return new AMap.InfoWindow({isCustom:!0,content:d.pointWindow(i.lng,i.lat,b[0]),offset:new AMap.Pixel(110,-25)}),!1}),AMap.event.addListener(c,"click",function(c){var e=a(c.target.da.bd.contentDom),h=e.offset(),i=g(h.left-f.left+7,h.top-f.top+e.height());return new AMap.InfoWindow({isCustom:!0,content:d.pointWindow(i.lng,i.lat,b[0]),offset:new AMap.Pixel(110,-25)}),!1}),i.off("mousemove"),i.off("mouseup"),h.css({top:0,left:0})}})}}function g(a,b){var c=d.containTolnglat(new AMap.Pixel(a,b));return{lng:c.getLng(),lat:c.getLat()}}var h=a(".drag-pin"),i=a(".container"),j=h.offset();return h.on("mousedown",b),{updateDragPosition:function(){j=h.offset(),j.left-=i.offset().left}}}():a(".drap-main").css("display","none"),d}}();return d});