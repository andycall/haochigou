define(["jquery","underscore","shop/port"],function(a,b,c){function d(a){for(var b in a)this[b]=a[b];this.itemList=[]}function e(){a("#total_count_basket").html(h.getTotalCount()),a("#total_price_basket").html(h.getTotalPrice()),a(".cgroup-item").each(function(b,c){var d=a(c),e=d.data("good_id");h.find(e,function(a){a&&a.count&&d.find(".cdish-qty").val(a.count)})})}function f(b,d){a.ajax({url:c.cartDel,type:"POST",data:{good_id:b,shop_id:d},success:function(c){"true"==c.success?(h.del(b),a(".cgroup-item[data-good_id="+b+"]").remove()):alert("网络错误!")}}),e()}function g(b,d,f){h.find(b,function(g){g?a.ajax({url:c.cartSetCount,type:"post",data:{good_id:b,shop_id:d,count:f},success:function(a){"true"==a.success?(g.count=f,e()):alert("网络错误!")}}):alert("请先添加这个商品!")})}d.prototype.find=function(a,b){"object"==typeof a&&(a=a.id);for(var c=0,d=this.itemList.length;d>c;c++)if(this.itemList[c].id==a)return b&&b(this.itemList[c]),this.itemList[c];return b&&b(null),!1},d.prototype.add=function(a,b){return this.find(a.id)?!1:(this.itemList.push(a),b&&b(a),!0)},d.prototype.setCount=function(a,b){var c=this.find(a);return c?void b(c):b(null)},d.prototype.del=function(a){"object"==typeof a&&(a=a.id);for(var b=0,c=this.itemList.length;c>b;b++)if(this.itemList[b].id==a)return this.itemList.splice(b,1);return!1},d.prototype.getTotalPrice=function(){var a=0;return this.itemList.forEach(function(b){var c=b.count||0;a+=parseInt(b.price*c)}),a},d.prototype.getTotalCount=function(){var a=0;return this.itemList.forEach(function(b){var c=b.count||0;a+=parseInt(c)}),a},d.prototype.empty=function(a){this.itemList=[],a&&a()};var h=new d;h.init=function(){a(".cgroup-item").each(function(b,c){var d=a(c),e={id:d.data("good_id"),price:d.find(".cdish-price").html(),count:d.find(".cdish-qty").val(),title:d.find(".cdish-name").html()};h.itemList.push(e)})},a("#cgroup-list").on("click",".dec_btn",function(b){var c=a(b.target).parents("li"),d=c.data("good_id"),e=c.data("shop_id"),h=parseInt(c.find(".cdish-qty").val());1>=h?f(d,e):g(d,e,h-1)}).on("click",".inc_btn",function(b){var c=a(b.target).parents("li"),d=c.data("good_id"),e=c.data("shop_id"),f=parseInt(c.find(".cdish-qty").val());g(d,e,f+1)}).on("click",".del",function(b){var c=a(b.target).parents("li"),d=c.data("good_id"),e=c.data("shop_id");f(d,e)}).on("keyup",".cdish-qty",function(b){var c=a(b.target),d=c.parents("li"),e=d.data("good_id"),h=d.data("shop_id"),i=parseInt(c.val());i?g(e,h,i):f(e,h)}),h.init(),console.log("good basket loaded")});